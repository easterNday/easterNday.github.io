import{_ as s,o as a,c as n,a as l}from"./app.12bed851.js";const u=JSON.parse('{"title":"Android 运行时资源覆盖","description":"","frontmatter":{},"headers":[{"level":2,"title":"什么是运行时资源覆盖","slug":"什么是运行时资源覆盖","link":"#什么是运行时资源覆盖","children":[]},{"level":2,"title":"RRO 原理","slug":"rro-原理","link":"#rro-原理","children":[]},{"level":2,"title":"RRO 实现方法","slug":"rro-实现方法","link":"#rro-实现方法","children":[]},{"level":2,"title":"实现样例","slug":"实现样例","link":"#实现样例","children":[{"level":3,"title":"ArrowOS 的 SetupWizard 实现欢迎页面替换","slug":"arrowos-的-setupwizard-实现欢迎页面替换","link":"#arrowos-的-setupwizard-实现欢迎页面替换","children":[{"level":4,"title":"AndroidManifest.xml 的写法","slug":"androidmanifest-xml-的写法","link":"#androidmanifest-xml-的写法","children":[]},{"level":4,"title":"Android.bp 编写","slug":"android-bp-编写","link":"#android-bp-编写","children":[]},{"level":4,"title":"覆盖文件编写","slug":"覆盖文件编写","link":"#覆盖文件编写","children":[]}]}]},{"level":2,"title":"添加到系统编译过程中","slug":"添加到系统编译过程中","link":"#添加到系统编译过程中","children":[]},{"level":2,"title":"注意事项","slug":"注意事项","link":"#注意事项","children":[]},{"level":2,"title":"参考","slug":"参考","link":"#参考","children":[]}],"relativePath":"Topic/Android/ROM/rro_overlays.md","lastUpdated":1687685751000}'),o={name:"Topic/Android/ROM/rro_overlays.md"},e=l(`<h1 id="android-运行时资源覆盖" tabindex="-1">Android 运行时资源覆盖 <a class="header-anchor" href="#android-运行时资源覆盖" aria-hidden="true">#</a></h1><h2 id="什么是运行时资源覆盖" tabindex="-1">什么是运行时资源覆盖 <a class="header-anchor" href="#什么是运行时资源覆盖" aria-hidden="true">#</a></h2><p>无需修改原 app 的代码，无需重新编译，就能覆盖 app 内的部分资源，从而实现修改 app 的部分 UI,后面简称 RRO。</p><h2 id="rro-原理" tabindex="-1">RRO 原理 <a class="header-anchor" href="#rro-原理" aria-hidden="true">#</a></h2><ul><li><p>应用通过 getString/getDrawable 去调用某个资源时,会将这个 resources ID 作为参数传给 framework 层。同一名称但不同状态的 resources ID 是一样的,比如不同分辨率但名称相同的图片分别被放置在了 drawable-hdpi/drawable-ldpi/drawable-mdpi 下，但在编译时针对该图片生成的 resources ID 只有一个。</p></li><li><p>为了快速查找到指定的资源，Apk 编译的时候会把 Java 文件里面的 R.String.app_name 替换成 ox7f123456 这种格式的值</p></li><li><p>每个 apk 里面都有一个文件(resources.arsc)记录着指定的 resource_id 对应的资源类型，如果是 string 类型，则记录的这个资源名称对应的所有语言的翻译，如果是 drawable 类型，则记录着哪些分辨率底下有这个资源。</p></li></ul><h2 id="rro-实现方法" tabindex="-1">RRO 实现方法 <a class="header-anchor" href="#rro-实现方法" aria-hidden="true">#</a></h2><ul><li>建立一个新的 overlay apk 项目，apk 项目底下有 res 文件夹，Android.mk、AndroidManifest.xml</li><li>修改 AndroidManifest.xml 配置 apk 的包名、要覆盖的 apk 的包名</li><li>修改 Android.mk 使得 apk 能集成到 system/vendor/overlay/目录下</li><li>找到需要覆盖的资源名，在 overlay apk 的 res 指定目录下定义同名的资源</li></ul><h2 id="实现样例" tabindex="-1">实现样例 <a class="header-anchor" href="#实现样例" aria-hidden="true">#</a></h2><h3 id="arrowos-的-setupwizard-实现欢迎页面替换" tabindex="-1">ArrowOS 的 SetupWizard 实现欢迎页面替换 <a class="header-anchor" href="#arrowos-的-setupwizard-实现欢迎页面替换" aria-hidden="true">#</a></h3><h4 id="androidmanifest-xml-的写法" tabindex="-1">AndroidManifest.xml 的写法 <a class="header-anchor" href="#androidmanifest-xml-的写法" aria-hidden="true">#</a></h4><p>在 Android 11 或更高版本中，用于定义叠加层资源映射的推荐机制是，在叠加层软件包的 <code>res/xml</code> 目录中创建一个文件，枚举应覆盖的目标资源及其替换值，然后将 <code>&lt;overlay&gt;</code> 清单标记的 <code>android:resourcesMap</code> 属性的值设置为对资源映射文件的引用，此处使用的是 <code>xml/overlays.xml</code>。</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#F07178;">xml</span><span style="color:#C792EA;"> version</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">manifest</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">xmlns</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://schemas.android.com/apk/res/android</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#C792EA;">package</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.google.android.setupwizard.dogday.overlay</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">versionCode</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">versionName</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">application</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">label</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SetupWizardOverlay</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">hasCode</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#BABED8;">     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">overlay</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">targetPackage</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.google.android.setupwizard</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">priority</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">0</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">targetName</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SetupWizard</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">isStatic</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">resourcesMap</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@xml/overlays</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">manifest</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><h4 id="android-bp-编写" tabindex="-1">Android.bp 编写 <a class="header-anchor" href="#android-bp-编写" aria-hidden="true">#</a></h4><div class="language-Makefile"><button title="Copy Code" class="copy"></button><span class="lang">Makefile</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#BABED8;">// Copyright (C) 2020 Paranoid Android</span></span>
<span class="line"><span style="color:#BABED8;">//</span></span>
<span class="line"><span style="color:#BABED8;">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span>
<span class="line"><span style="color:#BABED8;">// you may not use this file except in compliance with the License.</span></span>
<span class="line"><span style="color:#BABED8;">// You may obtain a copy of the License at</span></span>
<span class="line"><span style="color:#BABED8;">//</span></span>
<span class="line"><span style="color:#82AAFF;">//</span><span style="color:#BABED8;">      </span><span style="color:#82AAFF;">http</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;">//www.apache.org/licenses/LICENSE-2.0</span></span>
<span class="line"><span style="color:#BABED8;">//</span></span>
<span class="line"><span style="color:#BABED8;">// Unless required by applicable law or agreed to in writing, software</span></span>
<span class="line"><span style="color:#BABED8;">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span>
<span class="line"><span style="color:#BABED8;">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span>
<span class="line"><span style="color:#BABED8;">// See the License for the specific language governing permissions and</span></span>
<span class="line"><span style="color:#BABED8;">// limitations under the License.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">runtime_resource_overlay {</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#82AAFF;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> &quot;DogDaySetupWizardOverlay&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#82AAFF;">certificate</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> &quot;platform&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#82AAFF;">sdk_version</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> &quot;current&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#82AAFF;">product_specific</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> true</span></span>
<span class="line"><span style="color:#BABED8;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="覆盖文件编写" tabindex="-1">覆盖文件编写 <a class="header-anchor" href="#覆盖文件编写" aria-hidden="true">#</a></h4><p>如下所示，是一个简单的 <code>xml/overlays.xml</code> 编写，可以覆盖 <code>string</code>、 <code>bool</code> 等基本类型。</p><blockquote><p>这种方法目前仅支持 Android 11 版本及以上。</p></blockquote><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#F07178;">xml</span><span style="color:#C792EA;"> version</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">overlay</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">xmlns</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://schemas.android.com/apk/res/android</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">item</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">target</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">string/wizard_script_uri</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">value</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">android.resource://com.google.android.setupwizard.dogday.overlay/raw/wizard_script</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">item</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">target</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">string/welcome_message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">value</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">DogDay</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">item</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">target</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">drawable/welcome_bg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">value</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@drawable/welcome_bg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">item</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">target</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">style/WelcomeStartButton</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">value</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@style/WelcomeStartButton</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">overlay</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>或者你可以在 <code>res</code> 下同名目录创建相同的文件来进行值的覆盖，例如你想修改原来的应用中的 <code>res\\values\\dimens.xml</code> 这个文件中的部分值，你可以在你的 <code>Overlay</code> 应用文件夹下创建同样的 <code>res\\values\\dimens.xml</code> 这个文件，并在其中按照如下规则编写可覆盖对应值:</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#F07178;">xml</span><span style="color:#C792EA;"> version</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">resources</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dimen</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">welcome_start_button_margin_top</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">48.0dp</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dimen</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dimen</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">welcome_start_button_padding</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">16.0dp</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dimen</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">resources</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>可以看到上面的文件中我们将 <code>welcome_start_button_margin_top</code> 修改为了 <code>48.0dp</code> ，并修改了 <code>welcome_start_button_padding</code> 为 <code>16.0dp</code>。</p><p>如果你想修改对应的 <code>style</code> 和 <code>drawable</code> 的话，大致操作也相似，只需要在本地创建这些文件即可实现对应的内容覆盖，注释文件格式类型要保持一致（例如矢量图仍然需要矢量图进行替换，图片文件仍然用图片文件替换）。</p><h2 id="添加到系统编译过程中" tabindex="-1">添加到系统编译过程中 <a class="header-anchor" href="#添加到系统编译过程中" aria-hidden="true">#</a></h2><p><code>Overlay</code> 实际上是作为应用程序安装的，因此按照正常的应用程序添加过程来即可:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># RRO overlays</span></span>
<span class="line"><span style="color:#FFCB6B;">PRODUCT_PACKAGES</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">+=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">DogDaySetupWizardOverlay</span></span>
<span class="line"></span></code></pre></div><h2 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-hidden="true">#</a></h2><ul><li>不能覆盖 <code>layout</code>、<code>AndroidManifest.xml</code>、<code>asset</code> 目录</li><li>建议只覆盖字符资源、覆盖图片要谨慎</li></ul><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h2><ul><li><a href="http://broncho.top/2017/01/16/blogs/RuntimeResourceOverlay/" target="_blank" rel="noreferrer">Android 运行时资源覆盖</a></li><li><a href="https://source.android.google.cn/docs/core/architecture/rros?hl=zh-cn" target="_blank" rel="noreferrer">运行时资源叠加层 (RRO) - 官方文档</a></li></ul>`,29),p=[e];function t(r,c,D,i,F,y){return a(),n("div",null,p)}const h=s(o,[["render",t]]);export{u as __pageData,h as default};
