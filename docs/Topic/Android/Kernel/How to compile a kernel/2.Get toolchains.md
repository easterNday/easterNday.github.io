# 内核编译工具选取

> 本教程将基于小米 10S 的内核源码进行实例，其他型号的手机请自行寻找内核源码。具体内容可以参考我的[内核编译项目](https://github.com/DogDayAndroid/KSU_Thyme_BuildBot)。

通过上一节的知识，我们已经获取到内核源码。

强烈推荐您学习[[内核向] 交叉编译器的选择](https://www.akr-developers.com/d/129)以及[[白话文版] ClangBuiltLinux Clang 的使用](https://www.akr-developers.com/d/121)来学习工具链的配置。

同时可以配合[neutron-clang 的说明文档](https://github.com/Neutron-Toolchains/clang-build-catalogue/blob/main/README.md)来进行编译参数配置。

## 工具推荐

- [neutron-clang](https://github.com/Neutron-Toolchains/clang-build-catalogue)：这是为内核开发构建的 LLVM 和 Clang 编译器工具链。构建始终是从最新的 LLVM 源代码而不是稳定版本构建的，~~因此无法保证完全的稳定性~~。
- [阿菌•未霜 Clang/LLVM Toolchain with Binutils](https://gitea.com/Mandi-Sa/clang)：这是一个预构建的工具链，构建始终来自最新的 LLVM 和 Binutils 源而不是稳定版本，因此无法保证完全的稳定性。它是用 Full LTO、PGO 和 BOLT 构建的，以尽可能减少编译时间。
- [ClangBuiltLinux/tc-build](https://github.com/ClangBuiltLinux/tc-build)：类似前两个工具，但是这个工具需要自己在本地从 LLVM 的源码进行构建，但编译时间较长。

除此之外，一个比较保险的方法是从预编译内核机器的 `/proc/config.gz` 提取`，需要对应版本的[交叉编译器](https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+refs)以及 [Clang](https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/refs/heads/master)，自行选择合适版本下载即可，通过这种方式编译出来的内核一般是不会存在错误的。

## Neutron-Clang 使用介绍

这是为内核开发构建的 LLVM 和 Clang 编译器工具链。构建始终是从最新的 LLVM 源代码而不是稳定版本构建的，因此不能保证完全的稳定性。目前该编译链工具使用 `AntMan` 来同步工具，具体使用方法如下：

```bash
mkdir -p "$HOME/toolchains/neutron-clang"
cd "$HOME/toolchains/neutron-clang"
bash <(curl -s "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman") -S
```

一些更多的 `AntMan` 命令：

| 功能                   | 对应命令                              |
| ---------------------- | ------------------------------------- |
| 同步最新的工具链构建   | `./antman -S` 或 `./antman -S=latest` |
| 同步特定的工具链版本   | `./antman -S=<release tag>`           |
| 检查更新               | `./antman -U`                         |
| 检查更新和同步更新     | `./antman -Uy`                        |
| 同步特定更新           | `./antman -S=<release tag>`           |
| 删除同步构建           | `./antman -D`                         |
| 显示有关同步构建的信息 | `./antman -I`                         |
| 同步特定的工具链版本   | `./antman -S=<release tag>`           |

> 如果需要更多细节介绍，请运行 `./antman --help` 获取。

## ClangBuiltLinux

如果您想要使用这个工具链的话，那么其中的编译工具则需要你自行编译，对应的编译脚本为 [ClangBuiltLinux/tc-build](https://github.com/ClangBuiltLinux/tc-build)。

诚然，自行编译确实是一件造轮子且费时费力的方法，但是通过这种方式编译出来的工具是最适合您的系统的，不会发生其他的编译中的关于 `glibc` 等方面的错误。

## 阿菌•未霜 Clang/LLVM Toolchain with Binutils

这是一个预构建的工具链，构建始终来自最新的 LLVM 和 Binutils 源而不是稳定版本，因此无法保证完全的稳定性。它是用 Full LTO、PGO 和 BOLT 构建的，以尽可能减少编译时间。

其编译链工具存储在：

- [GitHub](https://github.com/Mandi-Sa/clang "GitHub")：仅用于发布预构建的压缩文件（\*.7z）
- [Gitea](https://gitea.com/Mandi-Sa/clang "Gitea")：仅用于存储预构建的二进制文件（Current AR Archive、ELF 64-bit LSB shared object 存储在 LFS）

## 参考

- [[内核向] 交叉编译器的选择](https://www.akr-developers.com/d/129)
- [[白话文版] ClangBuiltLinux Clang 的使用](https://www.akr-developers.com/d/121)
