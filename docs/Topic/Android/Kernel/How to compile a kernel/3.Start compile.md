# 内核编译脚本

> 本教程将基于小米 10S 的内核源码进行实例，其他型号的手机请自行寻找内核源码。具体内容可以参考我的[内核编译项目](https://github.com/DogDayAndroid/KSU_Thyme_BuildBot)。

自此，我们已经完成了**内核源码**和**编译工具链**的获取，那么接下来就让我们开始内核的编译吧。

## 内核编译流程

内核编译流程其实只有两步：

1. 生成对应设备的配置文件 `make <theDefConfig>`
2. 开始编译内核 `make`

### 简易配置脚本

首先给出一个最基础的配置脚本：

```bash
#!/bin/bash
args="-j$(nproc --all) \
O=out \
ARCH=arm64 \
CROSS_COMPILE=aarch64-linux-gnu- \
CC=clang \
CROSS_COMPILE_COMPAT=arm-linux-gnueabi- "
make ${args} <config name>
make ${args}
```

> 该脚本是在使用上一节的三个工具时才可以正常使用的，如果您使用其他工具可以需要进行其他配置。

下面是一些参数对应的说明：

| 参数                   | 说明                                                                                                                                   | 一般参数             |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| `CC`                   | 指定使用的编译器，因为 `make` 默认使用 `gcc`，因此实际上只有你在使用 `clang` 进行编译的时候才会使用该参数                              | `clang`              |
| `CROSS_COMPILE`        | 您的主要交叉编译链工具，如果你在使用谷歌的 gcc 4.9，请指定参数为 `aarch64-linux-android-`，32 位同理                                   | `aarch64-linux-gnu-` |
| `CLANG_TRIPLE`         | 只在使用 `clang` 进行编译的时候才需要使用，用于指定当 `clang` 不生效时候使用的工具链，但在使用上一节我们提到的工具中基本不用设置该参数 | `aarch64-linux-gnu-` |
| `CROSS_COMPILE_ARM32`  | 只在编译 32 位内核或者带 vdso 补丁的内核时需要指定该参数                                                                               | `arm-linux-gnueabi-` |
| `CROSS_COMPILE_COMPAT` | 类似于参数 `CROSS_COMPILE_ARM32` ，但内核版本为 4.19 及更新版本应使用本参数而非 `CROSS_COMPILE_ARM32`                                  | `arm-linux-gnueabi-` |

更多参数介绍可以参考一下[Neutron-clang 的编译说明](https://github.com/Neutron-Toolchains/clang-build-catalogue#building-linux)，里面对于一些参数的说明比较详细。

> 正常情况下，clang 是无法独立完成内核编译的，需要 gcc 的辅助。但使用上一节介绍的几种工具并不需要并不需要单独指定 `gcc` 来辅助编译。

在内核源码目录按照顺序执行该简易脚本即可开始编译，但通常来说你并不会成功，因为你的编译链环境并未设置正确。

## 设置编译链环境

最简单的设置环境办法就是将编译链工具的路径添加到系统路径中，例如：

```bash
export PATH="<absolute/path/to/ur/toolchains>/bin:$PATH"
# 例如，您正在使用 neutron-clang
# export PATH="home/user/toolchains/neutron-clang/bin:$PATH"
# 其中的路径必须为绝对路径
```

> 如果您在使用 `gcc`，可能还需要将 `gcc` 工具链的路径加入到环境变量中。

## 一些参考脚本

- [DogDayAndroid/KSU_Thyme_BuildBot](https://github.com/DogDayAndroid/KSU_Thyme_BuildBot/blob/main/build.sh)：我自己编译的内核使用的本地编译脚本。
- [UtsavBalar1231/Drone-scripts](https://github.com/UtsavBalar1231/Drone-scripts)：一个很多人使用的编译脚本，我的部分代码也是参考自这里。
- [EndCredits/kernel_xiaomi_sm7250](https://github.com/EndCredits/kernel_xiaomi_sm7250/blob/android-4.19-main/build.sh)：同样的一个编译脚本，但并未提供编译链，但是其中的脚本流程我也有参考。
- [xiaoleGun/KernelSU_Action](https://github.com/xiaoleGun/KernelSU_Action)：`KernelSU` 的编译脚本，同样有参考。

## 参考

- [Neutron-clang 的编译说明](https://github.com/Neutron-Toolchains/clang-build-catalogue#building-linux)
- [[内核向] 交叉编译器的选择](https://www.akr-developers.com/d/129)
- [[白话文版] ClangBuiltLinux Clang 的使用](https://www.akr-developers.com/d/121)
